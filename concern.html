<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Family Concern</title>
    <meta http-equiv="Cache-Control" content="no-transform" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=yes" />
    <link rel="stylesheet" href="/RequestDisPatcher/CSS/bootstrap.min.css">
    <script src="/RequestDisPatcher/JS/jquery-3.2.0.min.js"></script>
    <script src="/RequestDisPatcher/amcharts/amcharts.js"></script>
    <script src="/RequestDisPatcher/amcharts/serial.js"></script>
    <script src="/RequestDisPatcher/amcharts/themes/light.js"></script>
    <script src="/RequestDisPatcher/JS/xcConfirm.js"></script>
    <link rel="stylesheet" type="text/css" href="/RequestDisPatcher/CSS/xcConfirm.css"/>
    <link rel="stylesheet" type="text/css" href="/RequestDisPatcher/CSS/layout.css">
    <link rel="stylesheet" type="text/css" href="/RequestDisPatcher/CSS/global.css">
    <link rel="stylesheet" type="text/css" href="/RequestDisPatcher/CSS/font-awesome.min.css">
    <script type="text/javascript">
        $(document).ready(function(){
            var userInfo = document.cookie.match(new RegExp("(^| )userData=([^;]*)(;|$)"));
//            console.log(userInfo);
            var info = JSON.parse(userInfo[2]);
            console.log(info);
            var Info=info['userInfo'];
            var token = info.token;
            var myConcern;
            var concernMe;
            var applyConcern;
            var gender = Info.gender;

            var  image=Info.image;

            if(image==null){
                if(gender==1){

                    $('#head').attr('src','Heads/header_man.png');

                }else if(gender==0){

                    $('#head').attr('src','Heads/header_woman.png');

                }

            }else{
                $('#head').attr('src',image);
            }

            function cancelconcernMe() {
                $(".concern2 .concern202 .concern_item2").unbind().each(function(index,item){

                            $('.itme1_rabish',item).on("click",function(event) {


                                var email=$('.email',item)[0].innerText;
                                console.log(email);

                                var statu = confirm('确认取消此人关注？');
                                if(!statu){
                                    return false;
                                }
                                else{
                                    $(this).parents('.concern_item2').remove();
                                    $.ajax({
                                        type:"POST",
                                        url:"/RequestDisPatcher/request/dispatcher.do",
                                        data:{
                                            url:"http://127.0.0.1:9001/login/cancel",
                                            params:"email="+email+"&type="+'concernMe'+"&token="+token
                                        },
                                        dataType:"json",
                                        success:function(data) {
                                            console.log(data);
                                            $(item).parents('.concern_item2').remove();
//                                    location.reload();

                                        },
                                        error: function (jqXHR, textStatus, errorThrown,Code) {
                                            console.log(data);
                                            alert("Unkonw Error.Please Try Again!");
                                        }
                                    })
                                }


                            })
                        }
                )


            }


            function bindListener(){
                $('.concern_item1  .clickLi ').siblings().hide();
                $(".clickLi").unbind().each(function(index,item){

                    $(item).on("click",function(event){
                        $target=$(event.target);
                        var email=$('span:last-child',this).text();
                        $('.itme1_rabish',this).bind('click',function(){

                            var statu = confirm('确认取消关注？');
                            if(!statu){
                                return false;
                            }
                            else{
                                $.ajax({
                                    type:"POST",
                                    url:"/RequestDisPatcher/request/dispatcher.do",
                                    data:{
                                        url:"http://127.0.0.1:9001/login/cancel",
                                        params:"email="+email+"&type="+'myConcern'+"&token="+token
                                    },
                                    dataType:"json",
                                    success:function(data) {
                                        console.log(data);
                                        $(item).parents('.concern_item1').remove();
//                                    location.reload();

                                    },
                                    error: function (jqXHR, textStatus, errorThrown,Code) {
                                        console.log(data);
                                        alert("Unkonw Error.Please Try Again!");
                                    }
                                })
                            }
//                            var txt="确定不关注此人？";
//                            window.wxc.xcConfirm(txt, window.wxc.xcConfirm.typeEnum.confirm);
                        });

                        $(this).siblings().toggle('item1_product_list');
                    });
                });
            }

            function yesORno(num){
                $(".concern2 .concern201 .concern_item2 ").unbind().each(function(index,item){

                    $('.cancel .submit_submit',item).on("click",function(event){
                        var email=$('.email',item)[0].innerText;
                        var name=$('.name',item)[0].innerText;
                        var image=$('.header_pic img',item)[0].src;
                        $(this).parents('.concern_item2').remove();
                        $.ajax({
                            type:"post",
                            url:"/RequestDisPatcher/request/dispatcher.do",
                            data: {
                                url:"http://101.37.100.209:9001/login/handle",
                                params:"token="+token+"&email="+email+"&handle=agree"
                            },
                            success: function (data) {
                                console.log(data);
//                    console.log(data.Data.length);
                                $(this).parents('.concern_item2').remove();

                                $(".concern2 .concern202").append('<ul class="concern_item2"> <div class="detail_pic"> <div class="header_pic"> <i class="itme1_arrow"></i>  <img src="'+image+'" id="head"> <span class="name">'+name+'</span> <span class="email">'+email+'</span> </div><i class="itme1_rabish"></i> </div> </ul>');
                                $('.concern_list li:last-child  i span').text(num-1);

                                if($('.concern_list li:last-child  i span').text()==0) {

                                    $('.concern_list li:last-child  i').remove();

                                };

                            },
                            error: function (data) {
                                alert('faile');
                            }
                        });


                    });

                    $('.cancel .submit_back',item).on("click",function(event){
                        var email=$('.email',item)[0].innerText;
                        console.log(email);
                        $(this).parents('.concern_item2').remove();

                        $.ajax({
                            type:"post",
                            url:"/RequestDisPatcher/request/dispatcher.do",
                            data: {
                                url:"http://101.37.100.209:9001/login/handle",
                                params:"token="+token+"&email="+email+"&handle=disagree"
                            },
                            success: function (data) {
                                console.log(data);

                                $('.concern_list li:last-child  i span').text(num-1);
                                if($('.concern_list li:last-child  i span').text()==0) {

                                    $('.concern_list li:last-child  i').remove();

                                };

                                $(this).parents('.concern_item2').remove();

                            },
                            error: function (data) {
                                var txt=data.Message;
                                window.wxc.xcConfirm(txt, window.wxc.xcConfirm.typeEnum.confirm);
                            }
                        });

                    });
                });

            }
            $.ajax({
                type:"post",
                url:"/RequestDisPatcher/request/dispatcher.do",
                data: {
                    url:"http://127.0.0.1:9001/login/getWait",
                    params:"token="+token
                },
                success: function (data) {
//                    console.log(data.Data.length);
                    var num=data.Data.length;
//                    $('.concern_item2').empty();
                    if(num>0){
                        $('.concern_list li:last-child  i').addClass("num");
                        $('.concern_list li:last-child  i span').text(num);
                    };
                    $.each(data.Data, function(i, item) {
                        $(".concern2 .concern201").append('<ul class="concern_item2"><div class="detail_pic"> <div class="header_pic"> <i class="itme1_arrow"></i> <img src="'+item.image+'" id="head">  <span class="name">'+item.firstName+'</span> <span class="email">'+item.email+'</span> </div> <div class="cancel"> <input type="button" value="同意" name="yes" class="submit_submit"><input type="button" name="no"  value="拒绝" class="submit_back">  </div> </div> </ul>');
                    });
                    yesORno(num);
                },
                error: function (data) {
                    alert('faile');
                }
            });

            $.ajax({
                type:"post",
                url:"/RequestDisPatcher/request/dispatcher.do",
                data: {
                    url:"http://127.0.0.1:9001/login/getConcernMe",
                    params:"token="+token
                },
                success: function (data) {
//                    console.log(data);
//                    $('.concern_item2').empty();
                    $.each(data.Data, function(i, item) {
                        $(".concern2 .concern202").append('<ul class="concern_item2"> <div class="detail_pic"> <div class="header_pic"> <i class="itme1_arrow"></i>  <img src="'+item.image+'" id="head"> <span class="name">'+item.name+'</span> <span class="email">'+item.email+'</span> </div><i class="itme1_rabish"></i> </div> </ul>');
                    });



                    cancelconcernMe();




                },
                error: function (data) {
                    alert('faile');
                }
            });
            $.ajax({
                type:"post",
                url:"/RequestDisPatcher/request/dispatcher.do",
                data: {
                    url:"http://127.0.0.1:9001/login/getMyConcern",
                    params:"token="+token
                },
                success: function (data) {
                    console.log(data);
//                    $('.concern_item1').empty();
                    $.each(data.Data, function(i, item) {

                        var sn=item.device;
                        if(sn!=null){
                        if(sn.length==0){
                            $(".concern1").append('<ul class="concern_item1"> <div class="detail_pic"> <li class="clickLi"> <div class="header_pic"> <i class="itme1_arrow" ></i>  <img src="' + item.image + '" id="head">  <span class="name">' + item.name + '</span> <span class="email">' + item.email + '</span> </div> <i class="itme1_rabish"></i> </li> <li> <div class="item1_product_list"> <ul> <li><span style="color:#7f7373">智能床垫</span> <a href="#" title="No Device.Can not View!">查看实时数据</a> <a href="#" title="No Device.Can not View!">查看健康档案</a> </li> <li><span style="color:#7f7373">智能枕</span> <a href="#" title="No Device.Can not View!">查看实时数据</a> <a href="#" title="No Device.Can not View!">查看健康档案</a> </li> <li><span style="color:#7f7373">智能手环</span> <a href="#" title="No Device.Can not View!">查看实时数据</a> <a href="#" title="No Device.Can not View!">查看健康档案</a> </li> </ul> </div> </li> </div> </ul>');
                        }else{
                            $(".concern1").append('<ul class="concern_item1"> <div class="detail_pic"> <li class="clickLi"> <div class="header_pic"> <i class="itme1_arrow" ></i>  <img src="' + item.image + '" id="head">  <span class="name">' + item.name + '</span> <span class="email">' + item.email + '</span> </div> <i class="itme1_rabish"></i> </li> <li> <div class="item1_product_list"> <ul> <li><span>智能床垫</span> <a href="real.html?&email='+item.email+'&sn='+sn+'">查看实时数据</a> <a href="healthy.html?&email='+item.email+'">查看健康档案</a> </li> <li><span style="color:#7f7373">智能枕</span> <a href="#" title="No Device.Can not View!">查看实时数据</a> <a href="#" title="No Device.Can not View!">查看健康档案</a> </li> <li><span style="color:#7f7373">智能手环</span> <a href="#" title="No Device.Can not View!">查看实时数据</a> <a href="#" title="No Device.Can not View!">查看健康档案</a> </li> </ul> </div> </li> </div> </ul>');

                        }
                        }else{

                            $(".concern1").append('<ul class="concern_item1"> <div class="detail_pic"> <li class="clickLi"> <div class="header_pic"> <i class="itme1_arrow" ></i>  <img src="' + item.image + '" id="head">  <span class="name">' + item.name + '</span> <span class="email">' + item.email + '</span> </div> <i class="itme1_rabish"></i> </li> <li> <div class="item1_product_list"> <ul> <li><span style="color:#7f7373">智能床垫</span> <a href="#">查看实时数据</a> <a href="#">查看健康档案</a> </li> <li><span style="color:#7f7373">智能枕</span> <a href="#" title="No Device.Can not View!">查看实时数据</a> <a href="#" title="No Device.Can not View!">查看健康档案</a> </li> <li><span style="color:#7f7373">智能手环</span> <a href="#" title="No Device.Can not View!">查看实时数据</a> <a href="#" title="No Device.Can not View!">查看健康档案</a> </li> </ul> </div> </li> </div> </ul>');

                        }





                        ;

                    });

                    bindListener();
                },
                error: function (data) {
                    alert('faile');
                }
            });

            /* //实现鼠标悬浮文字提示
             function over(){
             document.getElementById("device_info").style.innerHTML="";
             }
             function out(){
             document.getElementById("device_info").style.innerHTML="No Device!";
             } */

            function quit() {
                $.ajax({
                    type:"post",
                    url:"/RequestDisPatcher/request/dispatcher.do",
                    data: {
                        url:"http://127.0.0.1:9001/login/logout",
                        params:"token="+token
                    },
                    success: function (data) {
                        alert(data.Message);
//                        var txt=data.Message;
//                        window.wxc.xcConfirm(txt, window.wxc.xcConfirm.typeEnum.confirm);
//
                    },
                    error: function (data) {
                        alert(data.Message);
                    }
                });
            }
        });
    </script>

</head>
<body>
<div class="holder">
    <div class="left_nav contest">
        <div class="header_text">
            <div class="header_text_right">
                <span class="header_pic"><a href="modify.html" ><img src="Heads/default.jpg" id="head"></a></span>
            </div>
        </div>
        <ul>
            <a href="login.html"><li onclick="quit()"  >退出登录</li></a>
            <a href="concern.html"><li class="on">亲请关注</li></a>
            <a href="productupgrade.html"><li>增值服务</li></a>
            <a href="" ><span title="Yet open, please wait patiently"><li>名医坐堂</li></span></a>
        </ul>
    </div>
    <div class="right_show">
        <h2>isleep</h2>
        <a href="homepage.html"><span class="glyphicon glyphicon-home"></span></a>
        <div class="show_detail">
            <div class="show_detail_data">
                <ul class="concern_list">
                    <li><span>关注申请</span></li>
                    <li><span>我的关注</span></li>
                    <li><span>关注我的</span><i><span></span></i></li>
                </ul>
                <div class="concern0">
                    <div class="left" >
                        <div class="panel_input item0_input">
                            <input type="email" class="" id="apply_txt"/>
                            <input type="button" class="search_btn" id="search_btn" >
                            <!--<img src="images/search.png" class="search_pic"/>-->
                        </div>
                    </div>
                </div>
                <div class="concern1"></div>
                <div class="concern2">
                    <div class="concern201"><h4>批准申请</h4> </div>
                    <div class="concern202"><h4>关注我的</h4> </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $('#search_btn').bind("click",function(){
        var userInfo = document.cookie.match(new RegExp("(^| )userData=([^;]*)(;|$)"));
        console.log(userInfo);
        var info = JSON.parse(userInfo[2]);
        var Info=info['userInfo'];
        var token = info.token;
        var approval_box0_email = $("#apply_txt").val();
        if ($.trim(approval_box0_email) == '') {
            alert("input email!");
            return false;
        }
        else{
            $.ajax({
                        type:"POST",
                        url:"/RequestDisPatcher/request/dispatcher.do",
                        data:{
                            url:"http://127.0.0.1:9001/login/query",
                            params:"email="+approval_box0_email
                        },
                        dataType:"json",
                        success:function(data) {
                            if(data.Code==1){
                                $(".concern_item0").remove();

                                $(".concern0").append(' <ul class="concern_item0"> <div  class="concern_someone_detail"> <div class="detail_pic"> <span class="header_pic"><img src="' + data.Data.image + '" id="head">  <p class="appl_name">' + data.Data.name + '</p> <p class="appl_email">' + data.Data.email + '</p> </span> <div class="detail_btn"> <input type="button" name="Submit" onclick="remove()" value="Cancel" class="submit_back"> <input type="button" value="Submit" id="submit_submit" class="submit_submit"> </div> </div> </div> </ul> ');

                                $("#submit_submit").click(function () {
                                    $.ajax({
                                        type:"POST",
                                        url:"/RequestDisPatcher/request/dispatcher.do",
                                        data:{
                                            url:"http://127.0.0.1:9001/login/apply",
                                            params:"token="+token+"&email="+approval_box0_email
                                        },
                                        dataType:"json",
                                        success:function(data) {
                                            alert(data.Message);
//                                            var txt=data.Message;
//                                            window.wxc.xcConfirm(txt, window.wxc.xcConfirm.typeEnum.confirm);
                                        },
                                        error: function (jqXHR, textStatus, errorThrown,Code) {
                                            alert("Unkonw Error.Please Try Again!");
                                        }
                                    })
                                });
                            }
                        },
                        error: function (jqXHR, textStatus, errorThrown,Code) {
                            alert("Unkonw Error.Please Try Again!");
                        }
                    }
            );}
    });

    //清除查询的结果
    function remove(){
        $(".concern_item0").remove();
    }

</script>
<!--<script src="/SleepMonitor/JS/mine.js"></script>-->
<script src="/RequestDisPatcher/JS/mine.js"></script>
</body>
</html>